{"version":3,"sources":["website_helpers/graph.cljs"],"mappings":"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","names":["website-helpers.graph/html","hiccup","sablono.server/render-static","sablono.interpreter/interpret","website-helpers.graph/create-sim","viz-state","map__30141","cljs.core/deref","cljs.core/--destructure-map","cljs.core.get","width","height","link-strength","charge-strength","center-x","center-y","collide-size","G__30142","js/d3.forceSimulation","js/d3.forceLink","p1__30133#","js/d3.forceManyBody","js/d3.forceCenter","js/d3.forceCollide","temp__5804__auto__","s","rid3.attrs/attrs","p1__30134#","p1__30135#","p1__30136#","p1__30137#","p1__30138#","p1__30139#","p1__30140#","website-helpers.graph/create-drag","sim","js/d3.drag","event","d","_","website-helpers.graph/merge-nodes","orig","new","id","orig-map","cljs.core.into","cljs.core.map_indexed","i","n","seq__30155","cljs.core/seq","chunk__30156","count__30157","i__30158","cljs.core/chunked-seq?","c__5568__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","old","G__30175","G__30184","x","y","vx","vy","fx","fy","p__30186","map__30187","website-helpers.graph/update-sim!","alpha-target","links","nodes","old-nodes","new-nodes","p1__30185#","G__30188","website-helpers.graph/viz","ratom","base-link","state-override-map","cljs.core.atom","cljs.core.merge","drag","color","js/d3.scaleOrdinal","add-circle","sel","p1__30189#","p1__30190#","p1__30191#","x__5130__auto__","y__5131__auto__","G__30196","add-text","p1__30192#","rid3.core/viz","svg","map__30200","initial-alpha","_ratom","cljs.core.swap_BANG_","cljs.core/assoc","p1__30193#","js/Math.sqrt","_event","node","js/window.open","clojure.string/replace","website-helpers.graph/prechew","app-state","cljs.core.update","cljs.core/clj->js"],"sourcesContent":[";; Taken from https://gist.github.com/prook/9e5cc9144d34a991978a2fd31b4ee487\n;; and comment thread https://github.com/gadfly361/rid3/issues/10.\n;; See documentation at https://github.com/d3/d3-force\n\n(ns website-helpers.graph \n  (:require\n   [sablono.core :as sab]\n   [sablono.server :as server]\n   [clojure.string :refer [replace]]\n   [rid3.core :as rid3 :refer [rid3->]]))\n\n\n(defn html\n  \"Turns hiccup like syntax into an HTML string.\"\n  [hiccup]\n  (server/render-static (sab/html hiccup)))\n\n\n(defn create-sim\n  [viz-state]\n  (let [{:keys [width height link-strength charge-strength center-x center-y\n                collide-size]}\n        @viz-state]\n    (doto (js/d3.forceSimulation)\n      (.stop)\n      (.force \"link\" (-> (js/d3.forceLink)\n                         (.strength link-strength)\n                         (.id #(.-index %))))\n      (.force \"charge\" (-> (js/d3.forceManyBody)\n                           (.strength charge-strength)))\n      (.force \"center\" (js/d3.forceCenter center-x center-y))\n      (.force \"collide\" (js/d3.forceCollide collide-size))\n      (.on \"tick\" (fn []\n                    (when-let [s (:links-sel @viz-state)]\n                      (rid3-> s\n                              {:x1 #(.. % -source -x)\n                               :y1 #(.. % -source -y)\n                               :x2 #(.. % -target -x)\n                               :y2 #(.. % -target -y)}))\n                    (when-let [s (:nodes-sel @viz-state)]\n                      (rid3-> s\n                              {:transform\n                               #(str \"translate(\" (.-x %) \",\" (.-y %) \")\")\n                               :x #(.-x %)\n                               :y #(.-y %)})))))))\n\n(defn create-drag\n  [sim]\n  (-> (js/d3.drag)\n      (.on \"start\" (fn started\n                     [event d _]\n                     (when (-> event .-active zero?)\n                       (-> sim\n                           (.alphaTarget 0.3)\n                           (.restart)))\n                     (set! (.-fx d) (.-x d))\n                     (set! (.-fy d) (.-y d))))\n      (.on \"drag\" (fn dragged\n                    [event d _]\n                    (set! (.-fx d) (.-x event))\n                    (set! (.-fy d) (.-y event))))\n      (.on \"end\" (fn ended\n                   [event d _]\n                   (when (-> event .-active zero?)\n                     (-> sim\n                         (.alphaTarget 0)))\n                   (set! (.-fx d) nil)\n                   (set! (.-fy d) nil)))))\n\n(defn merge-nodes\n  [orig new id]\n  (let [orig-map (into {} (map-indexed (fn [i n] [(id n) i]) orig))]\n    (doseq [n new]\n      (when-let [old (aget orig (orig-map (id n)))]\n        (when-let [x (.-x old)] (set! (.-x n) x))\n        (when-let [y (.-y old)] (set! (.-y n) y))\n        (when-let [vx (.-vx old)] (set! (.-vx n) vx))\n        (when-let [vy (.-vy old)] (set! (.-vy n) vy))\n        (when-let [fx (.-fx old)] (set! (.-fx n) fx))\n        (when-let [fy (.-fy old)] (set! (.-fy n) fy))))\n    new))\n\n(defn update-sim! [sim alpha-target {:keys [links nodes]}]\n  (let [old-nodes (.nodes sim)\n        new-nodes (merge-nodes old-nodes nodes #(.-name %))]\n    (doto sim\n      (.nodes new-nodes)\n      (-> (.force \"link\") (.links links))\n      (.alpha alpha-target)\n      (.restart))))\n\n(defn viz\n  [ratom base-link state-override-map]\n  ; TODO make this width and height the size of the user's screen by default\n  (let [viz-state (atom (merge {:width 2000\n                                :height 1500\n                                :link-strength 0.08\n                                :charge-strength -50\n                                :center-x 1000\n                                :center-y 750\n                                :collide-size 30\n                                ; The initial \"temperature\" of the simulation.\n                                :initial-alpha 4\n                                :hover-text-sel nil\n                                :links-sel nil\n                                :nodes-sel nil}\n                               state-override-map))\n        sim (create-sim viz-state)\n        drag (create-drag sim)\n        ;; See\n        ;; https://github.com/d3/d3-scale-chromatic/blob/main/README.md#api-reference\n        ;; for options.\n        ;; See https://stackoverflow.com/a/21208204 for custom schemes.\n        color (js/d3.scaleOrdinal [\"#377eb8\" \"#4daf4a\" \"#984ea3\" \"#ff7f00\"]) \n        add-circle (fn [sel]\n                     (rid3-> sel\n                             (.append \"ellipse\")\n                             {:stroke         \"#fff\"\n                              :stroke-width   1.5\n                              :rx             #(* 3 (count (.-name %)))\n                              :ry             #(/ (max 25 (.-size %)) 2)\n                              :fill           #(color (.-group %))\n                              :fill-opacity   0.7}))\n        add-text (fn [sel]\n                   (rid3-> sel\n                           (.append \"text\")\n                           {:text-anchor \"middle\"\n                            :font-size \"x-small\"\n                            :y 5}\n                           (.text #(.-name %))))]\n    (fn [ratom]\n      [rid3/viz\n       {:id     \"force-graph\"\n        :ratom  ratom\n        :svg    {:did-mount\n                 (fn [svg ratom]\n                   (let [{:keys [width height initial-alpha]} @viz-state]\n                     (rid3-> svg\n                             {:width   width\n                              :height  height\n                              :viewBox #js [0 0 width height]})\n                     (update-sim! sim initial-alpha @ratom)))\n                 :did-update\n                 (fn [svg ratom]\n                   (update-sim! sim 0.5 @ratom))}\n        :pieces [{:kind            :elem-with-data\n                  :class           \"links\"\n                  :tag             \"line\"\n                  :prepare-dataset (fn [ratom] (:links @ratom))\n                  :did-mount\n                  (fn [sel _ratom]\n                    (swap! viz-state assoc :links-sel sel)\n                    (rid3-> sel\n                            {:stroke         \"#999\"\n                             :stroke-opacity 0.6\n                             :stroke-width   #(-> (.-value %)\n                                                  js/Math.sqrt\n                                                  (/ 2))}))}\n                 {:kind            :elem-with-data\n                  :class           \"nodes\"\n                  :tag             \"g\"\n                  :prepare-dataset (fn [ratom] (:nodes @ratom))\n                  ; See\n                  ; https://github.com/kovasap/reddit-tree/blob/main/src/reddit_tree/graph.cljs\n                  ; for more possibilities here.\n                  :did-mount (fn [sel _ratom]\n                               (swap! viz-state assoc :nodes-sel sel)\n                               ; Based on https://stackoverflow.com/a/47401796\n                               (add-circle sel)\n                               (add-text sel)\n                               (rid3-> sel\n                                 (.on \"dblclick\"\n                                      (fn [_event node]\n                                        (js/window.open\n                                          (str base-link\n                                               (replace (.-path node)\n                                                        #\" \" \"+\")))))\n                                 (.call drag)))}]}])))\n\n(defn prechew\n  [app-state]\n  (-> @app-state\n      (update :nodes clj->js)\n      (update :links clj->js)))\n"]}